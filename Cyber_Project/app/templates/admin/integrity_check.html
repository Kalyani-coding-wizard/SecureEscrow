{% extends "base.html" %}

{% block title %}Integrity Check - SecureEscrow{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-shield-check text-primary me-2"></i>
    File Integrity Check
</h2>

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    This tool verifies that all stored contracts match their original SHA-256 hashes,
    detecting any potential tampering or corruption.
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-file-earmark-check me-2"></i>
            Verification Results ({{ results|length }} files)
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Contract</th>
                        <th>Status</th>
                        <th>Original Hash</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>
                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                            {{ result.contract.original_filename }}
                            <br>
                            <small class="text-muted">ID: {{ result.contract.id }}</small>
                        </td>
                        <td>
                            {% if result.is_valid %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle me-1"></i>Valid
                            </span>
                            {% else %}
                            <span class="badge bg-danger fs-6">
                                <i class="bi bi-x-circle me-1"></i>TAMPERED
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="small">{{ result.stored_hash[:20] }}...</code>
                        </td>
                        <td>
                            {% if result.error %}
                            <span class="text-danger">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                {{ result.error }}
                            </span>
                            {% elif result.is_valid %}
                            <span class="text-success">Hash matches</span>
                            {% else %}
                            <span class="text-danger">
                                Hash mismatch!<br>
                                <small>Current: {{ result.current_hash[:20] if result.current_hash else 'N/A'
                                    }}...</small>
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-4 text-muted">
                            No contracts to verify.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Summary -->
{% if results %}
{% set valid_count = results|selectattr('is_valid')|list|length %}
{% set invalid_count = results|length - valid_count %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card text-center {{ 'border-success' if invalid_count == 0 else 'border-danger' }}">
            <div class="card-body">
                <h2 class="{{ 'text-success' if invalid_count == 0 else 'text-danger' }}">
                    {% if invalid_count == 0 %}
                    <i class="bi bi-shield-check"></i> All Files Verified
                    {% else %}
                    <i class="bi bi-shield-exclamation"></i> {{ invalid_count }} Files Compromised
                    {% endif %}
                </h2>
                <p class="mb-0">
                    {{ valid_count }}/{{ results|length }} files passed integrity check
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6>Legend</h6>
                <p class="mb-1">
                    <span class="badge bg-success me-2">Valid</span>
                    File hash matches stored value - no tampering detected
                </p>
                <p class="mb-0">
                    <span class="badge bg-danger me-2">Tampered</span>
                    File hash does not match - possible data corruption or tampering
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}