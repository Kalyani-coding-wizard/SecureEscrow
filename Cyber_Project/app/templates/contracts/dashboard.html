{% extends "base.html" %}

{% block title %}Dashboard - SecureEscrow{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-speedometer2 text-primary me-2"></i>
        My Dashboard
    </h2>
    {% if current_user.can_initiate() %}
    <a href="{{ url_for('contracts.upload') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>New Contract
    </a>
    {% endif %}
</div>

<!-- Quick Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ owned_contracts|length }}</div>
            <div class="stat-label">My Contracts</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value text-warning">{{ pending_signatures|length }}</div>
            <div class="stat-label">Awaiting My Signature</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value text-success">{{ signed_contracts|length }}</div>
            <div class="stat-label">Signed by Me</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value text-info">{{ owned_contracts|selectattr('status', 'equalto',
                'finalized')|list|length }}</div>
            <div class="stat-label">Finalized</div>
        </div>
    </div>
</div>

<!-- Pending Signatures Alert -->
{% if pending_signatures %}
<div class="alert alert-warning d-flex align-items-center mb-4">
    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
    <div>
        <strong>Action Required:</strong> You have {{ pending_signatures|length }} contract(s) waiting for your
        signature.
    </div>
</div>
{% endif %}

<!-- Contracts Awaiting My Signature -->
{% if pending_signatures %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-pen text-warning me-2"></i>Awaiting My Signature</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>From</th>
                        <th>Progress</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in pending_signatures %}
                    <tr>
                        <td>
                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                            {{ contract.original_filename }}
                        </td>
                        <td>{{ contract.owner.username }}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="width: 100px;">
                                    <div class="progress-bar"
                                        style="width: {{ (contract.get_signature_count() / contract.get_required_count() * 100)|int if contract.get_required_count() > 0 else 0 }}%">
                                    </div>
                                </div>
                                <small>{{ contract.get_signature_count() }}/{{ contract.get_required_count() }}</small>
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('signing.sign', contract_id=contract.id) }}"
                                class="btn btn-warning btn-sm">
                                <i class="bi bi-pen me-1"></i>Sign
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- My Contracts -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-folder2 me-2"></i>My Contracts</h5>
    </div>
    <div class="card-body p-0">
        {% if owned_contracts %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>Status</th>
                        <th>Signatures</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in owned_contracts %}
                    <tr>
                        <td>
                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                            {{ contract.original_filename }}
                        </td>
                        <td>
                            {% if contract.status == 'pending' %}
                            <span class="badge status-pending">Pending</span>
                            {% elif contract.status == 'partially_signed' %}
                            <span class="badge status-partially-signed">Partially Signed</span>
                            {% else %}
                            <span class="badge status-finalized">Finalized</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="width: 80px;">
                                    <div class="progress-bar"
                                        style="width: {{ (contract.get_signature_count() / contract.get_required_count() * 100)|int if contract.get_required_count() > 0 else 0 }}%">
                                    </div>
                                </div>
                                <small>{{ contract.get_signature_count() }}/{{ contract.get_required_count() }}</small>
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">{{ contract.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </td>
                        <td>
                            <a href="{{ url_for('contracts.view', contract_id=contract.id) }}"
                                class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye me-1"></i>View
                            </a>
                            {% if contract.status == 'finalized' %}
                            <a href="{{ url_for('contracts.download', contract_id=contract.id) }}"
                                class="btn btn-success btn-sm">
                                <i class="bi bi-download me-1"></i>Download
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-folder2-open fs-1 mb-3 d-block"></i>
            <p>You haven't created any contracts yet.</p>
            {% if current_user.can_initiate() %}
            <a href="{{ url_for('contracts.upload') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>Create Your First Contract
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Contracts I've Signed -->
{% if signed_contracts %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-check2-circle text-success me-2"></i>Contracts I've Signed</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>Owner</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in signed_contracts %}
                    <tr>
                        <td>
                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                            {{ contract.original_filename }}
                        </td>
                        <td>{{ contract.owner.username }}</td>
                        <td>
                            {% if contract.status == 'finalized' %}
                            <span class="badge status-finalized">Finalized</span>
                            {% else %}
                            <span class="badge status-partially-signed">{{ contract.get_signature_count() }}/{{
                                contract.get_required_count() }} Signed</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('contracts.view', contract_id=contract.id) }}"
                                class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye me-1"></i>View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}